// Firestore security rules for Wall Decor Admin.
// Collection-level policies are defined per domain module.
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function myUserPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function myUserExists() {
      return signedIn() && exists(myUserPath());
    }

    function myUserData() {
      return get(myUserPath()).data;
    }

    function myRole() {
      // NOTE:
      // Custom claims bisa "nyangkut" (stale) dan override role di Firestore.
      // Supaya Spark-friendly dan nggak ke-lock, kita utamakan role dari users/{uid}.role.
      // Custom claim hanya dipakai kalau nilainya valid.
      // Implementasi dibuat sederhana untuk menghindari banyak get() saat query/list.
      return myUserExists() ? myUserData().role : null;
    }

    function isCEO() {
      return myRole() == 'CEO';
    }

    function isStaff() {
      let r = myRole();
      return r == 'CEO' || r == 'CTO' || r == 'CMO';
    }

    // USERS (karyawan) = users/{uid}
    match /users/{uid} {
      allow read: if isStaff() || (signedIn() && uid == request.auth.uid);

      // User membuat dokumen dirinya sendiri.
      // NOTE: role default harus non-privilege (PENDING). CEO akan approve dengan mengubah role.
      allow create: if signedIn()
        && uid == request.auth.uid
        && request.resource.data.role == 'PENDING';

      // CEO boleh update siapa pun.
      // User boleh update profil dirinya, tapi tidak boleh ubah email/role.
      allow update: if isCEO()
        || (signedIn()
          && uid == request.auth.uid
          && request.resource.data.email == resource.data.email
          && request.resource.data.role == resource.data.role
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['name', 'avatarDataUrl', 'position', 'updatedAt']));

      allow delete: if isCEO();
    }

    // PRODUCTS
    match /products/{id} {
      allow read: if isStaff();
      allow create, update: if isStaff();
      // delete produk hanya CEO
      allow delete: if isCEO();
    }

    // STOCK MOVEMENTS (audit log) - hanya create
    match /stockMovements/{id} {
      allow read: if isStaff();
      allow create: if isStaff()
        && request.resource.data.quantity is number
        && request.resource.data.quantity > 0;
      allow update: if false;
      allow delete: if isStaff();
    }

    // TRANSACTIONS (audit log) - hanya create
    match /transactions/{id} {
      allow read: if isStaff();
      allow create: if isStaff()
        && request.resource.data.amount is number
        && request.resource.data.amount > 0;
      allow update: if false;
      allow delete: if isStaff();
    }

    // PRODUCTIONS (audit log)
    match /productions/{id} {
      allow read: if isStaff();
      allow create: if isStaff()
        && request.resource.data.rawQuantity is number
        && request.resource.data.rawQuantity > 0
        && request.resource.data.finishedQuantity is number
        && request.resource.data.finishedQuantity > 0;
      allow update: if false;
      allow delete: if isStaff();
    }

    // MEETINGS (rekap rapat)
    match /meetings/{id} {
      allow read: if isStaff();
      allow create, update, delete: if isStaff();
    }

    // SETTINGS
    match /settings/{docId} {
      allow read: if isStaff();
      allow write: if isCEO();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
